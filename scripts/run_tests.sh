#!/bin/bash
set -e # å¦‚æœä»»ä½•å‘½ä»¤å¤±æ•—ï¼Œç«‹å³é€€å‡º

echo "======================================"
echo "ğŸš€ é–‹å§‹åŸ·è¡Œè’¼ç‹¼ AI å°ˆæ¡ˆè‡ªå‹•åŒ–æ¸¬è©¦ ğŸš€"
echo "======================================"
echo "åŸ·è¡Œæ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S %Z')"

# --- å¾Œç«¯æ¸¬è©¦ ---
echo -e "\nğŸ¨ æ­£åœ¨åŸ·è¡Œå¾Œç«¯ Python ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥ (flake8)..."
# æª¢æŸ¥ flake8 æ˜¯å¦å®‰è£ï¼Œå¦‚æœæœªå®‰è£å‰‡æç¤º (å¯é¸ï¼Œä½†è‰¯å¥½å¯¦è¸)
if ! command -v flake8 &> /dev/null
then
    echo "âš ï¸  è­¦å‘Š: flake8 å‘½ä»¤æœªæ‰¾åˆ°ï¼Œè·³éç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥ã€‚"
    echo "   è«‹ä½¿ç”¨ 'pip install flake8' å®‰è£å¾Œå†è©¦ã€‚"
else
    # åŸ·è¡Œ flake8ï¼Œé‡å° backend ç›®éŒ„
    if flake8 backend/; then
        echo "âœ… å¾Œç«¯ Python ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥é€šé (flake8)ã€‚"
    else
        echo "âŒ å¾Œç«¯ Python ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥æœªé€šé (flake8)ã€‚è«‹ä¿®æ­£ä»¥ä¸ŠéŒ¯èª¤ã€‚"
        exit 1 # é¢¨æ ¼æª¢æŸ¥å¤±æ•—å‰‡é€€å‡º
    fi
fi

echo -e "\nğŸ§ª åŸ·è¡Œå¾Œç«¯ Pytest æ¸¬è©¦ (æ–¼ backend/ ç›®éŒ„)..."
if [ -d "backend" ]; then
  cd backend
  echo "â„¹ï¸  ç›®å‰ç›®éŒ„: $(pwd)"
  echo "â„¹ï¸  åŸ·è¡Œ pytest..."
  if pytest; then
    echo "âœ… å¾Œç«¯ Pytest æ¸¬è©¦é€šéã€‚"

    # --- å°å‡º API Schema ---
    echo -e "\nğŸ¨ æ­£åœ¨ç”Ÿæˆ OpenAPI schema (openapi.json)..."
    # å‡è¨­ export_api_schema.py åœ¨ scripts/ ç›®éŒ„ä¸‹ï¼Œä¸”æˆ‘å€‘ç•¶å‰åœ¨ backend/ ç›®éŒ„
    # éœ€è¦å…ˆè¿”å›åˆ°å°ˆæ¡ˆæ ¹ç›®éŒ„æ‰èƒ½æ­£ç¢ºåŸ·è¡Œ
    cd ..
    echo "â„¹ï¸  ç›®å‰ç›®éŒ„: $(pwd) (æº–å‚™å°å‡º schema)"
    if python scripts/export_api_schema.py; then
      echo "âœ… OpenAPI schema å·²æˆåŠŸç”Ÿæˆæ–¼å°ˆæ¡ˆæ ¹ç›®éŒ„ã€‚"
    else
      echo "âŒ OpenAPI schema ç”Ÿæˆå¤±æ•—ã€‚"
      exit 1 # Schema ç”Ÿæˆå¤±æ•—å‰‡é€€å‡º
    fi
    # å¦‚æœå¾ŒçºŒé‚„æœ‰æ“ä½œéœ€è¦å¾ backend ç›®éŒ„åŸ·è¡Œï¼Œå‰‡éœ€è¦å†æ¬¡ cd backend
    # ä½†ç›®å‰å¾Œç«¯æ¸¬è©¦å·²çµæŸï¼Œä¸‹ä¸€å€‹æ˜¯å‰ç«¯æ¸¬è©¦ï¼Œæ‰€ä»¥ä¿æŒåœ¨æ ¹ç›®éŒ„æ˜¯OKçš„ï¼Œ
    # æˆ–è€…å‰ç«¯æ¸¬è©¦è‡ªå·±æœƒ cd frontendã€‚ç‚ºæ¸…æ™°èµ·è¦‹ï¼Œé€™è£¡æ˜ç¢ºè¿”å›æ ¹ç›®éŒ„å¾Œå†é€²è¡Œå‰ç«¯éƒ¨åˆ†ã€‚
    # ï¼ˆå¯¦éš›ä¸Šï¼Œä¸Šé¢çš„ cd .. å·²ç¶“è®“æˆ‘å€‘åœ¨æ ¹ç›®éŒ„äº†ï¼‰

  else
    echo "âŒ å¾Œç«¯ Pytest æ¸¬è©¦å¤±æ•—ã€‚"
    # set -e å°‡ç¢ºä¿è…³æœ¬åœ¨æ­¤è™•é€€å‡º
    # å¦‚æœéœ€è¦æ›´æ˜ç¢ºçš„æ§åˆ¶æˆ–æ¸…ç†æ“ä½œï¼Œå¯ä»¥ç§»é™¤ set -e ä¸¦æ‰‹å‹• exit 1
    exit 1
  fi
  # å¦‚æœ Pytest æˆåŠŸï¼Œä¸” schema å°å‡ºä¹ŸæˆåŠŸï¼Œæ­¤æ™‚æ‡‰è©²ä»åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„
  # å¦‚æœ Pytest å¤±æ•—ï¼Œè…³æœ¬å·²é€€å‡º
  # å¦‚æœ Pytest æˆåŠŸä½† schema å°å‡ºå¤±æ•—ï¼Œè…³æœ¬ä¹Ÿå·²é€€å‡º
  # å› æ­¤ï¼Œå¦‚æœèƒ½åŸ·è¡Œåˆ°é€™è£¡ï¼Œè¡¨ç¤ºå¾Œç«¯æ¸¬è©¦å’Œ schema å°å‡ºéƒ½æˆåŠŸäº†ã€‚
  # å¦‚æœä¹‹å‰æ˜¯å¾ backend ç›®éŒ„è¿”å›çš„ï¼Œé€™è£¡å°±ä¸éœ€è¦å†æ¬¡ cd ..
  # ç”±æ–¼æˆ‘åœ¨ schema å°å‡ºå‰åŠ äº† cd .. ï¼Œæ‰€ä»¥ç¾åœ¨çš„ pwd æ‡‰è©²æ˜¯å°ˆæ¡ˆæ ¹ç›®éŒ„
  # echo "â„¹ï¸  è¿”å›å°ˆæ¡ˆæ ¹ç›®éŒ„: $(pwd)" # é€™è¡Œå¯ä»¥çœç•¥æˆ–ç¢ºèª
else
  echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° backend/ ç›®éŒ„ï¼Œè·³éå¾Œç«¯æ¸¬è©¦åŠ schema ç”Ÿæˆã€‚"
fi

# --- å‰ç«¯æ¸¬è©¦ ---
echo -e "\nğŸ¨ æ­£åœ¨åŸ·è¡Œå‰ç«¯ç¨‹å¼ç¢¼å“è³ªèˆ‡é¢¨æ ¼æª¢æŸ¥ (ESLint)..."
if [ -d "frontend" ]; then
  cd frontend
  echo "â„¹ï¸  ç›®å‰ç›®éŒ„: $(pwd)"
  # æª¢æŸ¥ package.json ä¸­æ˜¯å¦æœ‰ lint å‘½ä»¤
  if grep -q '"lint":' package.json; then
    echo "â„¹ï¸  åµæ¸¬åˆ° 'npm run lint' å‘½ä»¤ï¼ŒåŸ·è¡Œä¸­..."
    if npm run lint; then
      echo "âœ… å‰ç«¯ ESLint æª¢æŸ¥é€šéã€‚"
    else
      echo "âŒ å‰ç«¯ ESLint æª¢æŸ¥æœªé€šéã€‚è«‹ä¿®æ­£ä»¥ä¸ŠéŒ¯èª¤ã€‚"
      exit 1 # ESLint æª¢æŸ¥å¤±æ•—å‰‡é€€å‡º
    fi
  else
    # å¦‚æœ package.json ä¸­æ²’æœ‰ lint å‘½ä»¤ï¼Œå˜—è©¦ç›´æ¥åŸ·è¡Œ npx eslint
    echo "âš ï¸  è­¦å‘Š: 'npm run lint' æœªåœ¨ package.json ä¸­å®šç¾©ã€‚"
    echo "â„¹ï¸  å˜—è©¦åŸ·è¡Œ npx eslint . --ext .ts,.tsx (è«‹ç¢ºä¿ ESLint å·²é…ç½®ä¸”ç›¸é—œå¥—ä»¶å·²å®‰è£)"
    if command -v npx &> /dev/null && npx eslint . --ext .ts,.tsx; then
      echo "âœ… å‰ç«¯ ESLint æª¢æŸ¥é€šé (ä½¿ç”¨ npx eslint)ã€‚"
    else
      echo "âŒ å‰ç«¯ ESLint æª¢æŸ¥å¤±æ•—æˆ– ESLint æœªæ­£ç¢ºé…ç½®/å®‰è£ (ä½¿ç”¨ npx eslint)ã€‚"
      echo "   è«‹ç¢ºä¿å°ˆæ¡ˆå·²é…ç½® ESLintï¼Œæˆ–åœ¨ package.json ä¸­å®šç¾© 'lint' æŒ‡ä»¤ã€‚"
      exit 1 # ESLint æª¢æŸ¥å¤±æ•—å‰‡é€€å‡º
    fi
  fi
  cd .. # å¾ frontend ç›®éŒ„è¿”å›å°ˆæ¡ˆæ ¹ç›®éŒ„
  echo "â„¹ï¸  è¿”å›å°ˆæ¡ˆæ ¹ç›®éŒ„: $(pwd)"
else
  echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° frontend/ ç›®éŒ„ï¼Œè·³éå‰ç«¯ ESLint æª¢æŸ¥åŠ Jest æ¸¬è©¦ã€‚"
fi


# ç¢ºä¿æˆ‘å€‘æ˜¯å¾å°ˆæ¡ˆæ ¹ç›®éŒ„é–‹å§‹åŸ·è¡Œå‰ç«¯æ¸¬è©¦ï¼ˆå¦‚æœå‰ç«¯æ¸¬è©¦çš„ cd frontend ä¾è³´æ­¤ï¼‰
echo -e "\nğŸ§ª åŸ·è¡Œå‰ç«¯ Jest æ¸¬è©¦ (æ–¼ frontend/ ç›®éŒ„)..."
if [ -d "frontend" ]; then
  cd frontend
  echo "â„¹ï¸  ç›®å‰ç›®éŒ„: $(pwd)"
  echo "â„¹ï¸  åŸ·è¡Œ npm test -- --passWithNoTests..."
  # npm test æœƒåŸ·è¡Œ package.json ä¸­ "scripts": { "test": "jest" }
  # Jest é è¨­æœƒåœ¨æ²’æœ‰æ‰¾åˆ°æ¸¬è©¦æª”æ¡ˆæ™‚å¤±æ•— (é™¤éæœ‰ --passWithNoTests æˆ–é¡ä¼¼é…ç½®)
  # Next.js çš„ Jest é…ç½®å¯èƒ½å·²ç¶“è™•ç†äº†é€™ä¸€é»ï¼Œä½†æ˜ç¢ºåŠ ä¸Šæ›´å®‰å…¨
  if npm test -- --passWithNoTests; then
    echo "âœ… å‰ç«¯ Jest æ¸¬è©¦é€šé (æˆ–æ²’æœ‰æ‰¾åˆ°æ¸¬è©¦æª”æ¡ˆ)ã€‚"
  else
    echo "âŒ å‰ç«¯ Jest æ¸¬è©¦å¤±æ•—ã€‚"
    exit 1
  fi
  cd ..
  echo "â„¹ï¸  è¿”å›å°ˆæ¡ˆæ ¹ç›®éŒ„: $(pwd)"
else
  echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° frontend/ ç›®éŒ„ï¼Œè·³éå‰ç«¯ Jest æ¸¬è©¦ã€‚" # æ­¤è­¦å‘Šå·²åœ¨ ESLint æ­¥é©Ÿä¸­çµ¦å‡ºï¼Œä½†ä¿ç•™ä¹Ÿç„¡å¦¨
fi

echo -e "\n======================================"
echo "ğŸ‰ æ‰€æœ‰æ¸¬è©¦åŸ·è¡Œå®Œç•¢ ğŸ‰"
echo "======================================"
