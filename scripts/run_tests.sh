#!/bin/bash
set -e # å¦‚æœä»»ä½•å‘½ä»¤å¤±æ•—ï¼Œç«‹å³é€€å‡º

echo "======================================"
echo "ğŸš€ é–‹å§‹åŸ·è¡Œè’¼ç‹¼ AI å°ˆæ¡ˆè‡ªå‹•åŒ–æ¸¬è©¦ ğŸš€"
echo "======================================"
echo "åŸ·è¡Œæ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S %Z')"

# --- å¾Œç«¯æ¸¬è©¦ ---
echo -e "\nğŸ§ª åŸ·è¡Œå¾Œç«¯ Pytest æ¸¬è©¦ (æ–¼ backend/ ç›®éŒ„)..."
if [ -d "backend" ]; then
  cd backend
  echo "â„¹ï¸  ç›®å‰ç›®éŒ„: $(pwd)"
  echo "â„¹ï¸  åŸ·è¡Œ pytest..."
  if pytest; then
    echo "âœ… å¾Œç«¯ Pytest æ¸¬è©¦é€šéã€‚"
  else
    echo "âŒ å¾Œç«¯ Pytest æ¸¬è©¦å¤±æ•—ã€‚"
    # set -e å°‡ç¢ºä¿è…³æœ¬åœ¨æ­¤è™•é€€å‡º
    # å¦‚æœéœ€è¦æ›´æ˜ç¢ºçš„æ§åˆ¶æˆ–æ¸…ç†æ“ä½œï¼Œå¯ä»¥ç§»é™¤ set -e ä¸¦æ‰‹å‹• exit 1
    exit 1
  fi
  cd ..
  echo "â„¹ï¸  è¿”å›å°ˆæ¡ˆæ ¹ç›®éŒ„: $(pwd)"
else
  echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° backend/ ç›®éŒ„ï¼Œè·³éå¾Œç«¯æ¸¬è©¦ã€‚"
fi

# --- å‰ç«¯æ¸¬è©¦ ---
echo -e "\nğŸ§ª åŸ·è¡Œå‰ç«¯ Jest æ¸¬è©¦ (æ–¼ frontend/ ç›®éŒ„)..."
if [ -d "frontend" ]; then
  cd frontend
  echo "â„¹ï¸  ç›®å‰ç›®éŒ„: $(pwd)"
  echo "â„¹ï¸  åŸ·è¡Œ npm test -- --passWithNoTests..."
  # npm test æœƒåŸ·è¡Œ package.json ä¸­ "scripts": { "test": "jest" }
  # Jest é è¨­æœƒåœ¨æ²’æœ‰æ‰¾åˆ°æ¸¬è©¦æª”æ¡ˆæ™‚å¤±æ•— (é™¤éæœ‰ --passWithNoTests æˆ–é¡ä¼¼é…ç½®)
  # Next.js çš„ Jest é…ç½®å¯èƒ½å·²ç¶“è™•ç†äº†é€™ä¸€é»ï¼Œä½†æ˜ç¢ºåŠ ä¸Šæ›´å®‰å…¨
  if npm test -- --passWithNoTests; then
    echo "âœ… å‰ç«¯ Jest æ¸¬è©¦é€šé (æˆ–æ²’æœ‰æ‰¾åˆ°æ¸¬è©¦æª”æ¡ˆ)ã€‚"
  else
    echo "âŒ å‰ç«¯ Jest æ¸¬è©¦å¤±æ•—ã€‚"
    exit 1
  fi
  cd ..
  echo "â„¹ï¸  è¿”å›å°ˆæ¡ˆæ ¹ç›®éŒ„: $(pwd)"
else
  echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° frontend/ ç›®éŒ„ï¼Œè·³éå‰ç«¯æ¸¬è©¦ã€‚"
fi

echo -e "\n======================================"
echo "ğŸ‰ æ‰€æœ‰æ¸¬è©¦åŸ·è¡Œå®Œç•¢ ğŸ‰"
echo "======================================"
